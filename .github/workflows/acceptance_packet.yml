name: Acceptance Packet

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: read

jobs:
  acceptance-packet:
    runs-on: ubuntu-latest
    # Anti-loop: skip if triggered by bot updating PR body
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run acceptance packet
        id: packet
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set +e
          mkdir -p artifacts

          # Run acceptance packet and capture output
          ./scripts/acceptance_packet.sh "$PR_NUMBER" 2>&1 | tee "artifacts/acceptance_packet_pr${PR_NUMBER}.txt"
          PACKET_EXIT=${PIPESTATUS[0]}

          set -e

          # Compute artifact metadata
          ARTIFACT_FILE="artifacts/acceptance_packet_pr${PR_NUMBER}.txt"
          SHA256=$(sha256sum "$ARTIFACT_FILE" | awk '{print $1}')
          BYTES=$(wc -c < "$ARTIFACT_FILE")

          echo "packet_exit=$PACKET_EXIT" >> "$GITHUB_OUTPUT"
          echo "artifact_file=$ARTIFACT_FILE" >> "$GITHUB_OUTPUT"
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          echo "bytes=$BYTES" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: acceptance_packet_pr${{ github.event.pull_request.number }}
          path: artifacts/acceptance_packet_pr${{ github.event.pull_request.number }}.txt
          retention-days: 90

      - name: Update PR body
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PACKET_EXIT: ${{ steps.packet.outputs.packet_exit }}
          SHA256: ${{ steps.packet.outputs.sha256 }}
          BYTES: ${{ steps.packet.outputs.bytes }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          ARTIFACT_FILE="artifacts/acceptance_packet_pr${PR_NUMBER}.txt"
          ARTIFACT_NAME="acceptance_packet_pr${PR_NUMBER}"
          CHECK_NAME="Acceptance Packet"

          # Save current PR body to file
          gh pr view "$PR_NUMBER" --json body -q '.body' > /tmp/current_body.txt || echo "" > /tmp/current_body.txt

          # Use Python for all the complex string handling
          python3 << 'PYEOF'
          import os
          import re

          pr_number = os.environ['PR_NUMBER']
          sha256 = os.environ['SHA256']
          bytes_size = os.environ['BYTES']
          head_sha = os.environ['HEAD_SHA']
          run_url = os.environ['RUN_URL']
          artifact_file = f"artifacts/acceptance_packet_pr{pr_number}.txt"
          artifact_name = f"acceptance_packet_pr{pr_number}"
          check_name = "Acceptance Packet"

          # Read current body
          with open('/tmp/current_body.txt', 'r') as f:
              current_body = f.read()

          # Read packet content
          with open(artifact_file, 'r') as f:
              packet_content = f.read()

          # Determine mode: FULL VERBATIM or CI ARTIFACT
          # GitHub PR body limit is ~65536 chars
          # Calculate what the total body size would be with FULL VERBATIM
          # Strip existing acceptance packet block to get base body size
          import re
          pattern = r'<!-- ACCEPTANCE_PACKET_START -->.*?<!-- ACCEPTANCE_PACKET_END -->'
          base_body = re.sub(pattern, '', current_body, flags=re.DOTALL).strip()

          # Estimate full verbatim size: base + packet + markdown overhead (~100 chars)
          full_verbatim_size = len(base_body) + len(packet_content) + 100

          # Use FULL VERBATIM only if total < 60000 and packet has diff
          if full_verbatim_size < 60000 and 'diff --git' in packet_content:
              # FULL VERBATIM mode
              new_block = f'''<!-- ACCEPTANCE_PACKET_START -->
          ```
          {packet_content}
          ```
          <!-- ACCEPTANCE_PACKET_END -->'''
          else:
              # CI ARTIFACT mode (body too large or no diff)
              new_block = f'''<!-- ACCEPTANCE_PACKET_START -->
          == ACCEPTANCE PACKET: CI ARTIFACT ==
          RUN_URL: {run_url}
          ARTIFACT_NAME: {artifact_name}
          SHA256: {sha256}
          BYTES: {bytes_size}
          CHECK_NAME: {check_name}
          HEAD_SHA: {head_sha}
          <!-- ACCEPTANCE_PACKET_END -->'''

          # Check if markers exist
          start_marker = '<!-- ACCEPTANCE_PACKET_START -->'
          end_marker = '<!-- ACCEPTANCE_PACKET_END -->'

          if start_marker in current_body:
              # Replace existing block
              pattern = r'<!-- ACCEPTANCE_PACKET_START -->.*?<!-- ACCEPTANCE_PACKET_END -->'
              new_body = re.sub(pattern, new_block.strip(), current_body, flags=re.DOTALL)
          else:
              # Append block
              new_body = current_body + '\n\n' + new_block.strip()

          # Check if body actually changed
          if new_body.strip() == current_body.strip():
              print("Body unchanged, skipping update")
          else:
              # Write new body to file
              with open('/tmp/new_body.txt', 'w') as f:
                  f.write(new_body)
              print("Body will be updated")
          PYEOF

          # Apply update if new body was written
          if [[ -f /tmp/new_body.txt ]]; then
            gh pr edit "$PR_NUMBER" --body-file /tmp/new_body.txt
            echo "PR body updated with acceptance packet"
          else
            echo "PR body unchanged, no update needed"
          fi

      - name: Fail if packet failed
        if: steps.packet.outputs.packet_exit != '0'
        run: |
          echo "Acceptance packet failed with exit code ${{ steps.packet.outputs.packet_exit }}"
          exit 1
