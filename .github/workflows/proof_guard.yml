name: Proof Guard

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

jobs:
  proof-guard:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    steps:
      - name: Validate PR body has required proof bundle markers
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'PY'
          import json, os, sys, urllib.request

          with open(os.environ["GITHUB_EVENT_PATH"], "r", encoding="utf-8") as f:
            event = json.load(f)

          pr = event.get("pull_request") or {}
          body = (pr.get("body") or "").strip()
          number = pr.get("number")
          repo = (event.get("repository") or {}).get("full_name")
          token = os.environ.get("GITHUB_TOKEN", "")

          if not number or not repo:
            print("ERROR: Cannot determine PR number or repository from event payload.")
            sys.exit(1)

          if not body:
            print("ERROR: PR description is empty. Proof bundle is REQUIRED.")
            print("TIP: Run ./scripts/proof_bundle.sh <PR_NUMBER> and paste the output.")
            sys.exit(1)

          # Required markers from proof_bundle.sh output (v3+file: 11 markers)
          # These markers indicate raw command output was pasted
          required_markers = [
            "== PROOF_BUNDLE_FILE ==",
            "== PR URL ==",
            "== GH PR VIEW ==",
            "== GH PR CHECKS ==",
            "== CHANGED FILES ==",
            "== TOOLCHAIN VERSIONS ==",
            "== GIT SHOW --STAT ==",
            "== GIT SHOW ==",
            "== RUFF CHECK . ==",
            "== MYPY . ==",
            "== PYTEST -Q ==",
          ]

          missing = [m for m in required_markers if m not in body]
          if missing:
            print("ERROR: Missing required proof bundle markers in PR body:")
            for m in missing:
              print(f" - {m}")
            print("")
            print("TIP: Run ./scripts/proof_bundle.sh <PR_NUMBER> and paste the FULL output into PR body.")
            sys.exit(1)

          # Sanity check: must have some actual output after markers (11 markers = 22 "==")
          if body.count("==") < 22:
            print("ERROR: PR body looks incomplete. Make sure you pasted FULL proof_bundle.sh output.")
            sys.exit(1)

          # Check for fixtures/replay requirement
          def gh_get(url: str):
            req = urllib.request.Request(url)
            req.add_header("Accept", "application/vnd.github+json")
            if token:
              req.add_header("Authorization", f"Bearer {token}")
            with urllib.request.urlopen(req) as r:
              return json.loads(r.read().decode("utf-8"))

          files = []
          page = 1
          while True:
            url = f"https://api.github.com/repos/{repo}/pulls/{number}/files?per_page=100&page={page}"
            chunk = gh_get(url)
            if not chunk:
              break
            files.extend([x.get("filename","") for x in chunk])
            if len(chunk) < 100:
              break
            page += 1

          # Expanded replay-related file detection (DEC-008)
          replay_patterns = [
              "tests/fixtures/",       # Fixture files
              "tests/replay/",         # Replay tests
              "scripts/run_replay.py", # Replay script
              "scripts/run_record.py", # Record script (affects replay determinism)
          ]

          def is_replay_related(filename: str) -> bool:
              return any(
                  filename.startswith(p) if p.endswith("/") else filename == p
                  for p in replay_patterns
              )

          replay_related_files = [f for f in files if is_replay_related(f)]
          require_replay = len(replay_related_files) > 0

          if require_replay:
            # Accept both python and python3 variants
            has_replay_proof = (
                "python -m scripts.run_replay" in body or
                "python3 -m scripts.run_replay" in body or
                "python3 scripts/run_replay.py" in body or
                "scripts.run_replay" in body
            )
            if not has_replay_proof:
              print("ERROR: This PR changes replay-related files. Must include replay determinism proof:")
              print(" - python3 scripts/run_replay.py --fixture <path> -v (or equivalent)")
              print("")
              print("Changed files that triggered this requirement:")
              for f in replay_related_files:
                  print(f" - {f}")

          print("OK: Proof bundle requirements satisfied.")
          print(f"INFO: PR #{number}, files: {len(files)}, replay required: {require_replay}")
          PY
