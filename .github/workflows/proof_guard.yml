name: Proof Guard

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

jobs:
  proof-guard:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    steps:
      - name: Validate PR body has required proof bundle markers
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'PY'
          import json, os, sys, urllib.request

          with open(os.environ["GITHUB_EVENT_PATH"], "r", encoding="utf-8") as f:
            event = json.load(f)

          pr = event.get("pull_request") or {}
          body = (pr.get("body") or "").strip()
          number = pr.get("number")
          repo = (event.get("repository") or {}).get("full_name")
          token = os.environ.get("GITHUB_TOKEN", "")

          if not number or not repo:
            print("ERROR: Cannot determine PR number or repository from event payload.")
            sys.exit(1)

          if not body:
            print("ERROR: PR description is empty. Proof bundle is REQUIRED.")
            print("TIP: Run ./scripts/proof_bundle.sh and paste the output.")
            sys.exit(1)

          # Required markers from proof_bundle.sh output
          # These markers indicate raw command output was pasted
          required_markers = [
            "== GIT SHOW --STAT ==",
            "== GIT SHOW ==",
            "== RUFF CHECK . ==",
            "== MYPY . ==",
            "== PYTEST -Q ==",
          ]

          missing = [m for m in required_markers if m not in body]
          if missing:
            print("ERROR: Missing required proof bundle markers in PR body:")
            for m in missing:
              print(f" - {m}")
            print("")
            print("TIP: Run ./scripts/proof_bundle.sh and paste the FULL output into PR body.")
            sys.exit(1)

          # Sanity check: must have some actual output after markers
          if body.count("==") < 10:
            print("ERROR: PR body looks incomplete. Make sure you pasted FULL proof_bundle.sh output.")
            sys.exit(1)

          # Check for fixtures/replay requirement
          def gh_get(url: str):
            req = urllib.request.Request(url)
            req.add_header("Accept", "application/vnd.github+json")
            if token:
              req.add_header("Authorization", f"Bearer {token}")
            with urllib.request.urlopen(req) as r:
              return json.loads(r.read().decode("utf-8"))

          files = []
          page = 1
          while True:
            url = f"https://api.github.com/repos/{repo}/pulls/{number}/files?per_page=100&page={page}"
            chunk = gh_get(url)
            if not chunk:
              break
            files.extend([x.get("filename","") for x in chunk])
            if len(chunk) < 100:
              break
            page += 1

          touches_fixtures = any(f.startswith("tests/fixtures/") for f in files)
          touches_replay = any(f == "scripts/run_replay.py" for f in files)
          require_replay = touches_fixtures or touches_replay

          if require_replay:
            if "python -m scripts.run_replay" not in body:
              print("ERROR: This PR changes fixtures/replay. Must include replay determinism proof:")
              print(" - python -m scripts.run_replay command and output")
              print("")
              print("Changed files that triggered this requirement:")
              for f in files:
                if f.startswith("tests/fixtures/") or f == "scripts/run_replay.py":
                  print(f" - {f}")
              sys.exit(1)

          print("OK: Proof bundle requirements satisfied.")
          print(f"INFO: PR #{number}, files: {len(files)}, replay required: {require_replay}")
          PY
