# DEC-025: Infrastructure Alert Rules for CryptoScreener
#
# Prometheus alerting rules for connector infrastructure metrics.
# Follows DEC-025 threshold planning and metric mapping from DECISIONS.md.
#
# STATUS: TEMPLATE ONLY - No runtime exporter implemented yet.
# These rules will become active when prometheus_client exporter is added.
# See: future PR "DEC-025-exporter" for runtime metrics export.
#
# IMPORTANT: These rules assume metrics are exported with the following names:
# - cryptoscreener_gov_* : RestGovernor metrics
# - cryptoscreener_cb_*  : CircuitBreaker metrics
# - cryptoscreener_ws_*  : WebSocket/connector metrics
#
# Low-cardinality labels only:
# - instance: pod/host identifier
# - job: service name
# - No symbol, endpoint, or other high-cardinality labels in alert rules

groups:
  - name: cryptoscreener_governor
    rules:
      # GOV_QUEUE_SATURATED: Backpressure building in REST governor queue
      - alert: GOV_QUEUE_SATURATED_WARNING
        expr: |
          (cryptoscreener_gov_current_queue_depth / cryptoscreener_gov_max_queue_depth) >= 0.80
        for: 1m
        labels:
          severity: warning
          component: rest_governor
        annotations:
          summary: "REST governor queue saturated (>= 80%)"
          description: |
            Queue depth at {{ $value | humanizePercentage }} of max capacity.
            Risk of request drops/timeouts. Check upstream rate limits.
          runbook_url: "https://docs.example.com/runbooks/gov_queue_saturated"

      - alert: GOV_QUEUE_SATURATED_CRITICAL
        expr: |
          (cryptoscreener_gov_current_queue_depth / cryptoscreener_gov_max_queue_depth) >= 0.95
        for: 2m
        labels:
          severity: critical
          component: rest_governor
        annotations:
          summary: "REST governor queue critically saturated (>= 95%)"
          description: |
            Queue depth at {{ $value | humanizePercentage }} of max capacity.
            Requests are likely being dropped. Immediate action required.
          runbook_url: "https://docs.example.com/runbooks/gov_queue_saturated"

      # GOV_SUSTAINED_DROPS: Requests being dropped with traffic gating
      # Traffic gate: only alert if request_rate > 10/min (avoid false positives on low volume)
      - alert: GOV_SUSTAINED_DROPS_WARNING
        expr: |
          (
            rate(cryptoscreener_gov_requests_dropped[5m])
            / (rate(cryptoscreener_gov_requests_allowed[5m]) + rate(cryptoscreener_gov_requests_dropped[5m]) + 0.001)
          ) > 0.001
          and
          (rate(cryptoscreener_gov_requests_allowed[5m]) + rate(cryptoscreener_gov_requests_dropped[5m])) * 60 > 10
        for: 10m
        labels:
          severity: warning
          component: rest_governor
        annotations:
          summary: "REST governor dropping > 0.1% of requests"
          description: |
            Drop ratio: {{ $value | humanizePercentage }}.
            Check drop_reason breakdown for cause (queue_full, timeout, breaker_open).
          runbook_url: "https://docs.example.com/runbooks/gov_sustained_drops"

      - alert: GOV_SUSTAINED_DROPS_CRITICAL
        expr: |
          (
            rate(cryptoscreener_gov_requests_dropped[5m])
            / (rate(cryptoscreener_gov_requests_allowed[5m]) + rate(cryptoscreener_gov_requests_dropped[5m]) + 0.001)
          ) > 0.01
          and
          (rate(cryptoscreener_gov_requests_allowed[5m]) + rate(cryptoscreener_gov_requests_dropped[5m])) * 60 > 10
        for: 5m
        labels:
          severity: critical
          component: rest_governor
        annotations:
          summary: "REST governor dropping > 1% of requests"
          description: |
            Drop ratio: {{ $value | humanizePercentage }}.
            Significant request loss. Check Binance status and circuit breaker state.
          runbook_url: "https://docs.example.com/runbooks/gov_sustained_drops"

      # GOV_CONCURRENCY_PINNED: Inflight requests at max
      - alert: GOV_CONCURRENCY_PINNED_WARNING
        expr: |
          cryptoscreener_gov_current_concurrent == cryptoscreener_gov_max_concurrent_requests
        for: 2m
        labels:
          severity: warning
          component: rest_governor
        annotations:
          summary: "REST governor concurrency pinned at max"
          description: |
            All {{ $value }} concurrent slots occupied for > 2m.
            Possible slow/stuck requests or upstream latency.
          runbook_url: "https://docs.example.com/runbooks/gov_concurrency_pinned"

      - alert: GOV_CONCURRENCY_PINNED_CRITICAL
        expr: |
          cryptoscreener_gov_current_concurrent == cryptoscreener_gov_max_concurrent_requests
        for: 10m
        labels:
          severity: critical
          component: rest_governor
        annotations:
          summary: "REST governor concurrency pinned at max for > 10m"
          description: |
            All {{ $value }} concurrent slots occupied for > 10m.
            Requests likely timing out. Check for stuck connections.
          runbook_url: "https://docs.example.com/runbooks/gov_concurrency_pinned"

  - name: cryptoscreener_circuit_breaker
    rules:
      # CB_FLAPPING: Circuit breaker opening frequently
      - alert: CB_FLAPPING_WARNING
        expr: |
          increase(cryptoscreener_cb_transitions_closed_to_open[10m]) >= 3
        labels:
          severity: warning
          component: circuit_breaker
        annotations:
          summary: "Circuit breaker flapping (>= 3 opens in 10m)"
          description: |
            {{ $value }} CLOSED->OPEN transitions in 10 minutes.
            Check open_reason breakdown (429, 418, error_code, threshold).
          runbook_url: "https://docs.example.com/runbooks/cb_flapping"

      - alert: CB_FLAPPING_CRITICAL
        expr: |
          increase(cryptoscreener_cb_transitions_closed_to_open[10m]) >= 10
        labels:
          severity: critical
          component: circuit_breaker
        annotations:
          summary: "Circuit breaker severe flapping (>= 10 opens in 10m)"
          description: |
            {{ $value }} CLOSED->OPEN transitions in 10 minutes.
            System unstable. Check Binance status and API key limits.
          runbook_url: "https://docs.example.com/runbooks/cb_flapping"

      # CB_STUCK_OPEN: Circuit breaker remained open too long
      # Uses last_open_duration_ms proxy (updated when exiting OPEN state)
      # Note: This fires AFTER recovery, showing how long it was stuck
      - alert: CB_STUCK_OPEN_WARNING
        expr: |
          cryptoscreener_cb_last_open_duration_ms > 300000
        labels:
          severity: warning
          component: circuit_breaker
        annotations:
          summary: "Circuit breaker was stuck OPEN > 5 minutes"
          description: |
            Last OPEN period lasted {{ $value | humanizeDuration }}.
            REST requests were blocked during this time.
          runbook_url: "https://docs.example.com/runbooks/cb_stuck_open"

      - alert: CB_STUCK_OPEN_CRITICAL
        expr: |
          cryptoscreener_cb_last_open_duration_ms > 600000
        labels:
          severity: critical
          component: circuit_breaker
        annotations:
          summary: "Circuit breaker was stuck OPEN > 10 minutes"
          description: |
            Last OPEN period lasted {{ $value | humanizeDuration }}.
            Prolonged API blockage. Review logs for root cause.
          runbook_url: "https://docs.example.com/runbooks/cb_stuck_open"

  - name: cryptoscreener_websocket
    rules:
      # WS_RECONNECT_STORM: Excessive disconnects or reconnect attempts
      # Primary signals: actual disconnects/attempts (catches storms even when limiter allows)
      - alert: WS_RECONNECT_STORM_WARNING
        expr: |
          increase(cryptoscreener_ws_total_disconnects[5m]) >= 10
          or
          increase(cryptoscreener_ws_total_reconnect_attempts[5m]) >= 20
        labels:
          severity: warning
          component: websocket
        annotations:
          summary: "WebSocket reconnect storm detected"
          description: |
            Disconnects (5m): {{ with printf "increase(cryptoscreener_ws_total_disconnects[5m])" | query }}{{ . | first | value }}{{ end }}
            Reconnect attempts (5m): {{ with printf "increase(cryptoscreener_ws_total_reconnect_attempts[5m])" | query }}{{ . | first | value }}{{ end }}
            Connection instability detected. Check network and Binance WS status.
          runbook_url: "https://docs.example.com/runbooks/ws_reconnect_storm"

      - alert: WS_RECONNECT_STORM_CRITICAL
        expr: |
          increase(cryptoscreener_ws_total_disconnects[5m]) >= 30
          or
          increase(cryptoscreener_ws_total_reconnect_attempts[5m]) >= 60
        labels:
          severity: critical
          component: websocket
        annotations:
          summary: "Severe WebSocket reconnect storm"
          description: |
            Disconnects (5m): {{ with printf "increase(cryptoscreener_ws_total_disconnects[5m])" | query }}{{ . | first | value }}{{ end }}
            Reconnect attempts (5m): {{ with printf "increase(cryptoscreener_ws_total_reconnect_attempts[5m])" | query }}{{ . | first | value }}{{ end }}
            Severe connectivity issues. Market data likely stale. Investigate immediately.
          runbook_url: "https://docs.example.com/runbooks/ws_reconnect_storm"

      # WS_RECONNECT_DENIED: Reconnects being blocked by limiter (secondary signal)
      - alert: WS_RECONNECT_DENIED_HIGH
        expr: |
          increase(cryptoscreener_ws_total_reconnects_denied[5m]) >= 5
        labels:
          severity: warning
          component: websocket
        annotations:
          summary: "WebSocket reconnects being denied by limiter"
          description: |
            {{ $value }} reconnect attempts denied in 5 minutes.
            Limiter protecting against storms, but indicates underlying instability.
          runbook_url: "https://docs.example.com/runbooks/ws_reconnect_storm"

      # WS_PING_TIMEOUTS: Ping/pong failures
      - alert: WS_PING_TIMEOUTS_WARNING
        expr: |
          increase(cryptoscreener_ws_total_ping_timeouts[5m]) > 0
        for: 5m
        labels:
          severity: warning
          component: websocket
        annotations:
          summary: "WebSocket ping timeouts occurring"
          description: |
            {{ $value }} ping timeouts in 5 minutes.
            Possible connectivity issues or event loop stalls.
          runbook_url: "https://docs.example.com/runbooks/ws_ping_timeouts"

      - alert: WS_PING_TIMEOUTS_CRITICAL
        expr: |
          increase(cryptoscreener_ws_total_ping_timeouts[5m]) >= 5
        labels:
          severity: critical
          component: websocket
        annotations:
          summary: "Frequent WebSocket ping timeouts"
          description: |
            {{ $value }} ping timeouts in 5 minutes.
            Connections may be stale. Check network and process health.
          runbook_url: "https://docs.example.com/runbooks/ws_ping_timeouts"

      # WS_SUBSCRIBE_DELAY_HIGH: Outbound subscribe requests being throttled
      - alert: WS_SUBSCRIBE_DELAY_HIGH
        expr: |
          increase(cryptoscreener_ws_total_subscribe_delayed[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: websocket
        annotations:
          summary: "WebSocket subscribe requests being throttled"
          description: |
            {{ $value }} subscribe requests delayed by throttler in 5 minutes.
            Subscription bursts may cause delays in stream activation.
          runbook_url: "https://docs.example.com/runbooks/ws_subscribe_delay"
